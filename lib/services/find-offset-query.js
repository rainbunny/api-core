"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.findOffsetQuery = void 0;

var _rxjs = require("rxjs");

var _operators = require("rxjs/operators");

var _helpers = require("../helpers");

const findInRepository = repository => query => {
  var _query$fields, _query$fields$paginat;

  return (0, _rxjs.zip)(repository.find(query), (_query$fields = query.fields) !== null && _query$fields !== void 0 && (_query$fields$paginat = _query$fields.pagination) !== null && _query$fields$paginat !== void 0 && _query$fields$paginat.total ? repository.count(query) : (0, _rxjs.of)(0)).pipe((0, _operators.map)(([data, total]) => ({
    data,
    pagination: {
      total,
      rowsPerPage: query.rowsPerPage,
      pageIndex: query.pageIndex
    }
  })));
};

const findOffsetQuery = ({
  query,
  repository,
  querySchema,
  validatePermissions
}) => (0, _rxjs.of)(query).pipe((0, _operators.map)(_helpers.sanitizeOffsetQuery), (0, _operators.switchMap)((0, _helpers.validateSchema)(querySchema)), (0, _operators.switchMap)(q => validatePermissions ? validatePermissions(q).pipe((0, _operators.map)(() => q)) : (0, _rxjs.of)(q)), (0, _operators.switchMap)(findInRepository(repository)));

exports.findOffsetQuery = findOffsetQuery;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlcy9maW5kLW9mZnNldC1xdWVyeS50cyJdLCJuYW1lcyI6WyJmaW5kSW5SZXBvc2l0b3J5IiwicmVwb3NpdG9yeSIsInF1ZXJ5IiwiZmluZCIsImZpZWxkcyIsInBhZ2luYXRpb24iLCJ0b3RhbCIsImNvdW50IiwicGlwZSIsImRhdGEiLCJyb3dzUGVyUGFnZSIsInBhZ2VJbmRleCIsImZpbmRPZmZzZXRRdWVyeSIsInF1ZXJ5U2NoZW1hIiwidmFsaWRhdGVQZXJtaXNzaW9ucyIsInNhbml0aXplT2Zmc2V0UXVlcnkiLCJxIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBRUEsTUFBTUEsZ0JBQWdCLEdBQ3BCQyxVQUR1QixJQUVuQkMsS0FBRDtBQUFBOztBQUFBLFNBQ0gsZUFBSUQsVUFBVSxDQUFDRSxJQUFYLENBQWdCRCxLQUFoQixDQUFKLEVBQTRCLGlCQUFBQSxLQUFLLENBQUNFLE1BQU4saUZBQWNDLFVBQWQsd0VBQTBCQyxLQUExQixHQUFrQ0wsVUFBVSxDQUFDTSxLQUFYLENBQWlCTCxLQUFqQixDQUFsQyxHQUE0RCxjQUFHLENBQUgsQ0FBeEYsRUFBK0ZNLElBQS9GLENBQ0Usb0JBQUksQ0FBQyxDQUFDQyxJQUFELEVBQU9ILEtBQVAsQ0FBRCxNQUFvQjtBQUN0QkcsSUFBQUEsSUFEc0I7QUFFdEJKLElBQUFBLFVBQVUsRUFBRTtBQUNWQyxNQUFBQSxLQURVO0FBRVZJLE1BQUFBLFdBQVcsRUFBRVIsS0FBSyxDQUFDUSxXQUZUO0FBR1ZDLE1BQUFBLFNBQVMsRUFBRVQsS0FBSyxDQUFDUztBQUhQO0FBRlUsR0FBcEIsQ0FBSixDQURGLENBREc7QUFBQSxDQUZMOztBQWNPLE1BQU1DLGVBVTZCLEdBQUcsQ0FBQztBQUFDVixFQUFBQSxLQUFEO0FBQVFELEVBQUFBLFVBQVI7QUFBb0JZLEVBQUFBLFdBQXBCO0FBQWlDQyxFQUFBQTtBQUFqQyxDQUFELEtBQzNDLGNBQUdaLEtBQUgsRUFBVU0sSUFBVixDQUNFLG9CQUFJTyw0QkFBSixDQURGLEVBRUUsMEJBQVUsNkJBQWVGLFdBQWYsQ0FBVixDQUZGLEVBR0UsMEJBQVdHLENBQUQsSUFBUUYsbUJBQW1CLEdBQUdBLG1CQUFtQixDQUFDRSxDQUFELENBQW5CLENBQXVCUixJQUF2QixDQUE0QixvQkFBSSxNQUFNUSxDQUFWLENBQTVCLENBQUgsR0FBK0MsY0FBR0EsQ0FBSCxDQUFwRixDQUhGLEVBSUUsMEJBQVVoQixnQkFBZ0IsQ0FBQ0MsVUFBRCxDQUExQixDQUpGLENBWEsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XG5pbXBvcnQgdHlwZSB7U2NoZW1hT2Z9IGZyb20gJ3l1cCc7XG5pbXBvcnQge29mLCB6aXB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHttYXAsIHN3aXRjaE1hcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHR5cGUge0VudGl0eSwgT2Zmc2V0UXVlcnksIE9mZnNldFF1ZXJ5UmVzdWx0LCBSZWFkUmVwb3NpdG9yeX0gZnJvbSAnLi4vaW50ZXJmYWNlcyc7XG5pbXBvcnQge3Nhbml0aXplT2Zmc2V0UXVlcnksIHZhbGlkYXRlU2NoZW1hfSBmcm9tICcuLi9oZWxwZXJzJztcblxuY29uc3QgZmluZEluUmVwb3NpdG9yeSA9IDxJZCA9IHN0cmluZywgRSBleHRlbmRzIEVudGl0eTxJZD4gPSBFbnRpdHk8SWQ+LCBRIGV4dGVuZHMgT2Zmc2V0UXVlcnkgPSBPZmZzZXRRdWVyeT4oXG4gIHJlcG9zaXRvcnk6IFJlYWRSZXBvc2l0b3J5PElkLCBFPixcbikgPT4gKHF1ZXJ5OiBRKTogT2JzZXJ2YWJsZTxPZmZzZXRRdWVyeVJlc3VsdDxJZCwgRT4+ID0+XG4gIHppcChyZXBvc2l0b3J5LmZpbmQocXVlcnkpLCBxdWVyeS5maWVsZHM/LnBhZ2luYXRpb24/LnRvdGFsID8gcmVwb3NpdG9yeS5jb3VudChxdWVyeSkgOiBvZigwKSkucGlwZShcbiAgICBtYXAoKFtkYXRhLCB0b3RhbF0pID0+ICh7XG4gICAgICBkYXRhLFxuICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICB0b3RhbCxcbiAgICAgICAgcm93c1BlclBhZ2U6IHF1ZXJ5LnJvd3NQZXJQYWdlLFxuICAgICAgICBwYWdlSW5kZXg6IHF1ZXJ5LnBhZ2VJbmRleCxcbiAgICAgIH0sXG4gICAgfSkpLFxuICApO1xuXG5leHBvcnQgY29uc3QgZmluZE9mZnNldFF1ZXJ5OiA8XG4gIElkID0gc3RyaW5nLFxuICBFIGV4dGVuZHMgRW50aXR5PElkPiA9IEVudGl0eTxJZD4sXG4gIFEgZXh0ZW5kcyBPZmZzZXRRdWVyeSA9IE9mZnNldFF1ZXJ5XG4+KHBhcmFtczoge1xuICBxdWVyeTogUTtcbiAgZGVmYXVsdFF1ZXJ5PzogUGFydGlhbDxRPjtcbiAgcmVwb3NpdG9yeTogUmVhZFJlcG9zaXRvcnk8SWQsIEU+O1xuICBxdWVyeVNjaGVtYTogU2NoZW1hT2Y8dW5rbm93bj47XG4gIHZhbGlkYXRlUGVybWlzc2lvbnM/OiAocXVlcnk6IFEpID0+IE9ic2VydmFibGU8dm9pZD47XG59KSA9PiBPYnNlcnZhYmxlPE9mZnNldFF1ZXJ5UmVzdWx0PElkLCBFPj4gPSAoe3F1ZXJ5LCByZXBvc2l0b3J5LCBxdWVyeVNjaGVtYSwgdmFsaWRhdGVQZXJtaXNzaW9uc30pID0+XG4gIG9mKHF1ZXJ5KS5waXBlKFxuICAgIG1hcChzYW5pdGl6ZU9mZnNldFF1ZXJ5KSxcbiAgICBzd2l0Y2hNYXAodmFsaWRhdGVTY2hlbWEocXVlcnlTY2hlbWEpKSxcbiAgICBzd2l0Y2hNYXAoKHEpID0+ICh2YWxpZGF0ZVBlcm1pc3Npb25zID8gdmFsaWRhdGVQZXJtaXNzaW9ucyhxKS5waXBlKG1hcCgoKSA9PiBxKSkgOiBvZihxKSkpLFxuICAgIHN3aXRjaE1hcChmaW5kSW5SZXBvc2l0b3J5KHJlcG9zaXRvcnkpKSxcbiAgKTtcbiJdfQ==