"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.updateEntity = void 0;

var _rxjs = require("rxjs");

var _operators = require("rxjs/operators");

var _helpers = require("../helpers");

const updateEntity = ({
  entity,
  repository,
  schema,
  validatePermissions,
  user,
  fields
}) => (0, _helpers.validateSchema)(schema)(entity).pipe((0, _operators.switchMap)(({
  id
}) => repository.getById({
  id,
  fields: fields || {
    id: {},
    createdBy: {}
  }
})), (0, _operators.map)(_helpers.validateEntityExist), (0, _operators.switchMap)(e => validatePermissions ? validatePermissions(e) : (0, _rxjs.of)(e)), (0, _operators.map)(() => ({ ...entity,
  lastModifiedBy: user === null || user === void 0 ? void 0 : user.id
})), (0, _operators.switchMap)(repository.update));

exports.updateEntity = updateEntity;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlcy91cGRhdGUtZW50aXR5LnRzIl0sIm5hbWVzIjpbInVwZGF0ZUVudGl0eSIsImVudGl0eSIsInJlcG9zaXRvcnkiLCJzY2hlbWEiLCJ2YWxpZGF0ZVBlcm1pc3Npb25zIiwidXNlciIsImZpZWxkcyIsInBpcGUiLCJpZCIsImdldEJ5SWQiLCJjcmVhdGVkQnkiLCJ2YWxpZGF0ZUVudGl0eUV4aXN0IiwiZSIsImxhc3RNb2RpZmllZEJ5IiwidXBkYXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBSUE7O0FBRU8sTUFBTUEsWUFPUyxHQUFHLENBQUM7QUFBQ0MsRUFBQUEsTUFBRDtBQUFTQyxFQUFBQSxVQUFUO0FBQXFCQyxFQUFBQSxNQUFyQjtBQUE2QkMsRUFBQUEsbUJBQTdCO0FBQWtEQyxFQUFBQSxJQUFsRDtBQUF3REMsRUFBQUE7QUFBeEQsQ0FBRCxLQUN2Qiw2QkFBOEJILE1BQTlCLEVBQXNDRixNQUF0QyxFQUE4Q00sSUFBOUMsQ0FDRSwwQkFBVSxDQUFDO0FBQUNDLEVBQUFBO0FBQUQsQ0FBRCxLQUFVTixVQUFVLENBQUNPLE9BQVgsQ0FBbUI7QUFBQ0QsRUFBQUEsRUFBRDtBQUFLRixFQUFBQSxNQUFNLEVBQUVBLE1BQU0sSUFBSTtBQUFDRSxJQUFBQSxFQUFFLEVBQUUsRUFBTDtBQUFTRSxJQUFBQSxTQUFTLEVBQUU7QUFBcEI7QUFBdkIsQ0FBbkIsQ0FBcEIsQ0FERixFQUVFLG9CQUFJQyw0QkFBSixDQUZGLEVBR0UsMEJBQVdDLENBQUQsSUFBUVIsbUJBQW1CLEdBQUdBLG1CQUFtQixDQUFDUSxDQUFELENBQXRCLEdBQTRCLGNBQUdBLENBQUgsQ0FBakUsQ0FIRixFQUlFLG9CQUFJLE9BQU8sRUFBQyxHQUFHWCxNQUFKO0FBQVlZLEVBQUFBLGNBQWMsRUFBRVIsSUFBRixhQUFFQSxJQUFGLHVCQUFFQSxJQUFJLENBQUVHO0FBQWxDLENBQVAsQ0FBSixDQUpGLEVBS0UsMEJBQVVOLFVBQVUsQ0FBQ1ksTUFBckIsQ0FMRixDQVJLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtvZn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge21hcCwgc3dpdGNoTWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgdHlwZSB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XG5pbXBvcnQgdHlwZSB7U2NoZW1hT2Z9IGZyb20gJ3l1cCc7XG5pbXBvcnQgdHlwZSB7QXV0aFVzZXIsIEVudGl0eSwgRmllbGRzLCBXcml0ZVJlcG9zaXRvcnl9IGZyb20gJy4uL2ludGVyZmFjZXMnO1xuaW1wb3J0IHt2YWxpZGF0ZVNjaGVtYSwgdmFsaWRhdGVFbnRpdHlFeGlzdH0gZnJvbSAnLi4vaGVscGVycyc7XG5cbmV4cG9ydCBjb25zdCB1cGRhdGVFbnRpdHk6IDxJZCA9IHN0cmluZywgRSBleHRlbmRzIEVudGl0eTxJZD4gPSBFbnRpdHk8SWQ+PihwYXJhbXM6IHtcbiAgZW50aXR5OiB7aWQ6IElkfSAmIFBhcnRpYWw8RT47XG4gIHJlcG9zaXRvcnk6IFdyaXRlUmVwb3NpdG9yeTxJZCwgRT47XG4gIHNjaGVtYT86IFNjaGVtYU9mPHVua25vd24+O1xuICB2YWxpZGF0ZVBlcm1pc3Npb25zPzogKGVudGl0eToge2lkOiBJZH0gJiBQYXJ0aWFsPEU+KSA9PiBPYnNlcnZhYmxlPHtpZDogSWR9ICYgUGFydGlhbDxFPj47XG4gIHVzZXI6IEF1dGhVc2VyO1xuICBmaWVsZHM/OiBGaWVsZHM7XG59KSA9PiBPYnNlcnZhYmxlPHZvaWQ+ID0gKHtlbnRpdHksIHJlcG9zaXRvcnksIHNjaGVtYSwgdmFsaWRhdGVQZXJtaXNzaW9ucywgdXNlciwgZmllbGRzfSkgPT5cbiAgdmFsaWRhdGVTY2hlbWE8dHlwZW9mIGVudGl0eT4oc2NoZW1hKShlbnRpdHkpLnBpcGUoXG4gICAgc3dpdGNoTWFwKCh7aWR9KSA9PiByZXBvc2l0b3J5LmdldEJ5SWQoe2lkLCBmaWVsZHM6IGZpZWxkcyB8fCB7aWQ6IHt9LCBjcmVhdGVkQnk6IHt9fX0pKSxcbiAgICBtYXAodmFsaWRhdGVFbnRpdHlFeGlzdCksXG4gICAgc3dpdGNoTWFwKChlKSA9PiAodmFsaWRhdGVQZXJtaXNzaW9ucyA/IHZhbGlkYXRlUGVybWlzc2lvbnMoZSkgOiBvZihlKSkpLFxuICAgIG1hcCgoKSA9PiAoey4uLmVudGl0eSwgbGFzdE1vZGlmaWVkQnk6IHVzZXI/LmlkfSkpLFxuICAgIHN3aXRjaE1hcChyZXBvc2l0b3J5LnVwZGF0ZSksXG4gICk7XG4iXX0=