"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.findOffsetQuery = void 0;

var _rxjs = require("rxjs");

var _operators = require("rxjs/operators");

var _helpers = require("../helpers");

const findInRepository = repository => query => {
  var _query$fields, _query$fields$paginat;

  return (0, _rxjs.zip)(repository.find(query), (_query$fields = query.fields) !== null && _query$fields !== void 0 && (_query$fields$paginat = _query$fields.pagination) !== null && _query$fields$paginat !== void 0 && _query$fields$paginat.total ? repository.count(query) : (0, _rxjs.of)(0)).pipe((0, _operators.map)(([data, total]) => ({
    data,
    pagination: {
      total,
      rowsPerPage: query.rowsPerPage,
      pageIndex: query.pageIndex
    }
  })));
};

const findOffsetQuery = ({
  query,
  repository,
  querySchema,
  validatePermissions
}) => (0, _rxjs.of)(query).pipe((0, _operators.map)(_helpers.sanitizeOffsetQuery), (0, _operators.switchMap)((0, _helpers.validateSchema)(querySchema)), (0, _operators.switchMap)(q => validatePermissions ? validatePermissions(q).pipe((0, _operators.map)(() => q)) : (0, _rxjs.of)(q)), (0, _operators.switchMap)(findInRepository(repository)));

exports.findOffsetQuery = findOffsetQuery;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlcy9maW5kLW9mZnNldC1xdWVyeS50cyJdLCJuYW1lcyI6WyJmaW5kSW5SZXBvc2l0b3J5IiwicmVwb3NpdG9yeSIsInF1ZXJ5IiwiZmluZCIsImZpZWxkcyIsInBhZ2luYXRpb24iLCJ0b3RhbCIsImNvdW50IiwicGlwZSIsImRhdGEiLCJyb3dzUGVyUGFnZSIsInBhZ2VJbmRleCIsImZpbmRPZmZzZXRRdWVyeSIsInF1ZXJ5U2NoZW1hIiwidmFsaWRhdGVQZXJtaXNzaW9ucyIsInNhbml0aXplT2Zmc2V0UXVlcnkiLCJxIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBSUE7O0FBRUEsTUFBTUEsZ0JBQWdCLEdBRWxCQyxVQURGLElBR0NDLEtBQUQ7QUFBQTs7QUFBQSxTQUNFLGVBQUlELFVBQVUsQ0FBQ0UsSUFBWCxDQUFnQkQsS0FBaEIsQ0FBSixFQUE0QixpQkFBQUEsS0FBSyxDQUFDRSxNQUFOLGlGQUFjQyxVQUFkLHdFQUEwQkMsS0FBMUIsR0FBa0NMLFVBQVUsQ0FBQ00sS0FBWCxDQUFpQkwsS0FBakIsQ0FBbEMsR0FBNEQsY0FBRyxDQUFILENBQXhGLEVBQStGTSxJQUEvRixDQUNFLG9CQUFJLENBQUMsQ0FBQ0MsSUFBRCxFQUFPSCxLQUFQLENBQUQsTUFBb0I7QUFDdEJHLElBQUFBLElBRHNCO0FBRXRCSixJQUFBQSxVQUFVLEVBQUU7QUFDVkMsTUFBQUEsS0FEVTtBQUVWSSxNQUFBQSxXQUFXLEVBQUVSLEtBQUssQ0FBQ1EsV0FGVDtBQUdWQyxNQUFBQSxTQUFTLEVBQUVULEtBQUssQ0FBQ1M7QUFIUDtBQUZVLEdBQXBCLENBQUosQ0FERixDQURGO0FBQUEsQ0FKRjs7QUFnQk8sTUFBTUMsZUFVNkIsR0FBRyxDQUFDO0FBQUNWLEVBQUFBLEtBQUQ7QUFBUUQsRUFBQUEsVUFBUjtBQUFvQlksRUFBQUEsV0FBcEI7QUFBaUNDLEVBQUFBO0FBQWpDLENBQUQsS0FDM0MsY0FBR1osS0FBSCxFQUFVTSxJQUFWLENBQ0Usb0JBQUlPLDRCQUFKLENBREYsRUFFRSwwQkFBVSw2QkFBZUYsV0FBZixDQUFWLENBRkYsRUFHRSwwQkFBV0csQ0FBRCxJQUFRRixtQkFBbUIsR0FBR0EsbUJBQW1CLENBQUNFLENBQUQsQ0FBbkIsQ0FBdUJSLElBQXZCLENBQTRCLG9CQUFJLE1BQU1RLENBQVYsQ0FBNUIsQ0FBSCxHQUErQyxjQUFHQSxDQUFILENBQXBGLENBSEYsRUFJRSwwQkFBVWhCLGdCQUFnQixDQUFDQyxVQUFELENBQTFCLENBSkYsQ0FYSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7b2YsIHppcH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge21hcCwgc3dpdGNoTWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgdHlwZSB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XG5pbXBvcnQgdHlwZSB7U2NoZW1hT2Z9IGZyb20gJ3l1cCc7XG5pbXBvcnQgdHlwZSB7RW50aXR5LCBPZmZzZXRRdWVyeSwgT2Zmc2V0UXVlcnlSZXN1bHQsIFJlYWRSZXBvc2l0b3J5fSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7c2FuaXRpemVPZmZzZXRRdWVyeSwgdmFsaWRhdGVTY2hlbWF9IGZyb20gJy4uL2hlbHBlcnMnO1xuXG5jb25zdCBmaW5kSW5SZXBvc2l0b3J5ID1cbiAgPElkID0gc3RyaW5nLCBFIGV4dGVuZHMgRW50aXR5PElkPiA9IEVudGl0eTxJZD4sIFEgZXh0ZW5kcyBPZmZzZXRRdWVyeSA9IE9mZnNldFF1ZXJ5PihcbiAgICByZXBvc2l0b3J5OiBSZWFkUmVwb3NpdG9yeTxJZCwgRT4sXG4gICkgPT5cbiAgKHF1ZXJ5OiBRKTogT2JzZXJ2YWJsZTxPZmZzZXRRdWVyeVJlc3VsdDxJZCwgRT4+ID0+XG4gICAgemlwKHJlcG9zaXRvcnkuZmluZChxdWVyeSksIHF1ZXJ5LmZpZWxkcz8ucGFnaW5hdGlvbj8udG90YWwgPyByZXBvc2l0b3J5LmNvdW50KHF1ZXJ5KSA6IG9mKDApKS5waXBlKFxuICAgICAgbWFwKChbZGF0YSwgdG90YWxdKSA9PiAoe1xuICAgICAgICBkYXRhLFxuICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgdG90YWwsXG4gICAgICAgICAgcm93c1BlclBhZ2U6IHF1ZXJ5LnJvd3NQZXJQYWdlLFxuICAgICAgICAgIHBhZ2VJbmRleDogcXVlcnkucGFnZUluZGV4LFxuICAgICAgICB9LFxuICAgICAgfSkpLFxuICAgICk7XG5cbmV4cG9ydCBjb25zdCBmaW5kT2Zmc2V0UXVlcnk6IDxcbiAgSWQgPSBzdHJpbmcsXG4gIEUgZXh0ZW5kcyBFbnRpdHk8SWQ+ID0gRW50aXR5PElkPixcbiAgUSBleHRlbmRzIE9mZnNldFF1ZXJ5ID0gT2Zmc2V0UXVlcnksXG4+KHBhcmFtczoge1xuICBxdWVyeTogUTtcbiAgZGVmYXVsdFF1ZXJ5PzogUGFydGlhbDxRPjtcbiAgcmVwb3NpdG9yeTogUmVhZFJlcG9zaXRvcnk8SWQsIEU+O1xuICBxdWVyeVNjaGVtYTogU2NoZW1hT2Y8dW5rbm93bj47XG4gIHZhbGlkYXRlUGVybWlzc2lvbnM/OiAocXVlcnk6IFEpID0+IE9ic2VydmFibGU8dm9pZD47XG59KSA9PiBPYnNlcnZhYmxlPE9mZnNldFF1ZXJ5UmVzdWx0PElkLCBFPj4gPSAoe3F1ZXJ5LCByZXBvc2l0b3J5LCBxdWVyeVNjaGVtYSwgdmFsaWRhdGVQZXJtaXNzaW9uc30pID0+XG4gIG9mKHF1ZXJ5KS5waXBlKFxuICAgIG1hcChzYW5pdGl6ZU9mZnNldFF1ZXJ5KSxcbiAgICBzd2l0Y2hNYXAodmFsaWRhdGVTY2hlbWEocXVlcnlTY2hlbWEpKSxcbiAgICBzd2l0Y2hNYXAoKHEpID0+ICh2YWxpZGF0ZVBlcm1pc3Npb25zID8gdmFsaWRhdGVQZXJtaXNzaW9ucyhxKS5waXBlKG1hcCgoKSA9PiBxKSkgOiBvZihxKSkpLFxuICAgIHN3aXRjaE1hcChmaW5kSW5SZXBvc2l0b3J5KHJlcG9zaXRvcnkpKSxcbiAgKTtcbiJdfQ==